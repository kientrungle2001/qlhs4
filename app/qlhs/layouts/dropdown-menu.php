<!-- Source: https://catalin.red/dist/uploads/2011/03/css3-dropdown-menu-demo.html -->
<ul id="menu">
	<li><a href="{url /}">Tổng quan</a></li>
	<li><a href="{url /test/schedule}">Thi đầu vào</a></li>
	<li><a href="{url /demo/muster}">Điểm danh</a>
		<ul>
			<li><a href="{url /teacher/schedule}">ĐD giáo viên</a></li>
			<li><a href="{url /student/schedule}">ĐD học sinh</a></li>
		</ul>
	</li>
	<li>
		<a href="{url /student}">Học sinh</a>
		<ul>
			<li>
				<a href="{url /student/center}">Trung tâm</a>
				<ul>
					<li><a href="{url /student/classed}">Đã xếp lớp</a></li>
					<li><a href="{url /student/unclassed}">Danh sách chờ</a></li>
					<li><a href="{url /student/ontest}">Test đầu vào</a></li>
				</ul>
			</li>
			<li>
				<a href="{url /student/online}">Trực tuyến</a>
				<ul>
					<li><a href="{url /student/potential}">Tiềm năng</a></li>
					<li><a href="{url /student/used}">Đang sử dụng</a></li>
					<li><a href="{url /student/familiar}">Thân thiết</a></li>
				</ul>				
			</li>
			
			<li><a href="{url /test/advice}">Tư vấn Phần mềm</a></li>
			<li><a href="{url /test/problem}">Vụ việc - lỗi</a></li>
			<li><a href="{url /demo/orderstat}">Bảng học phí</a></li>
			
		</ul>
	</li>
	<li>
		<a href="{url /subject}">Môn học</a>
		<ul>
			<li>
				<a href="{url /subject/center}">Môn học</a>				
			</li>
			<li>
				<a href="{url /subject/online}">Phần mềm</a>		
			</li>
			<li>
				<a href="{url /subject/book}">Sách</a>		
			</li>
		</ul>		
	</li>
	<li>
		<a href="{url /course}">Khóa học</a>
		<ul>
			<li>
				<a href="{url /course/center}">Trung tâm</a>
			</li>
			<li>
				<a href="{url /course/online}">Trực tuyến</a>
			</li>
			<li>
				<a href="{url /course/book}">Sách</a>
			</li>
			<li>
				<a href="{url /course/unclassed}">Danh sách chờ</a>
			</li>
			<li><a href="{url /course/student}">Xếp lớp</a></li>
			
		</ul>	
	</li>
	<li>
		<a href="{url /teacher}">Nhân sự</a>
		<ul>
			<li><a href="{url /teacher/lecturer}">Giảng viên</a></li>
			<li><a href="{url /teacher/tutor}">Trợ giảng</a></li>
			<li><a href="{url /teacher/employee}">Nhân viên</a></li>
			<li><a href="{url /teacher/partner}">Đối tác</a></li>
			<li><a href="{url /department}">Phòng ban</a></li>
			<li><a href="{url /employee/absent}">Ngày nghỉ</a></li>
			<li><a href="{url /teacher/billing}">Bảng lương</a></li>
			<li><a href="{url /teacher/create_billing}">Tạo HĐ Chi 1 mục</a></li>
			<li><a href="{url /teacher/create_billing_multiple}">Tạo HĐ Chi nhiều mục</a></li>
			<li><a href="{url /center}">Trung tâm</a></li>
			<li><a href="{url /room}">Phòng học</a></li>
		</ul>	
	</li>
	<li>
		<a href="{url /test}">Bài thi</a>	
		<ul>
			<li>
				<a href="#">Bài thi cho lớp</a>
			</li>
			<li>
				<a href="#">Điểm thi</a>
			</li>
		</ul>
	</li>
	<!--
	<li>
		<a href="{url /employee}">Nhân viên</a>
		<ul>
		<li>
				<a href="{url /department}">Phòng ban</a>
			</li>
			<li>
				<a href="{url /employee/absent}">Ngày nghỉ</a>
			</li>
			<li>
			<a href="{url /employee/billing}">Bảng lương</a>
			</li>
			<li><a href="{url /employee/create_billing}">Tạo HĐ Chi 1 mục</a></li>
			<li><a href="{url /employee/create_billing_multiple}">Tạo HĐ Chi nhiều mục</a></li>
		</ul>
	</li>
	<li>
		<a href="{url /partner}">Đối tác</a>
		<ul>
			<li><a href="{url /partner/order}">Hóa đơn thu</a></li>
			<li><a href="{url /partner/billing}">Hóa đơn chi</a></li>
			<li><a href="{url /partner/create_billing}">Tạo HĐ Chi 1 mục</a></li>
			<li><a href="{url /partner/create_billing_multiple}">Tạo HĐ Chi nhiều mục</a></li>
		</ul>
	</li>
	-->
	<li>
		<a href="#">Trung tâm</a>
		<ul>
		
		<li><a href="{url /course/schedule}">Lịch học</a></li>
		<li><a href="{url /offschedule}">Lịch nghỉ</a></li>
		<li><a href="{url /paymentperiod}">Kỳ thanh toán</a></li>
		<li><a href="{url /schedule/daily}">TKB Theo ngày</a></li>
			<li><a href="{url /schedule/weekly}">TKB Theo tuần</a></li>
			<li><a href="{url /schedule/teacher}">TKB Theo giáo viên</a></li>
			<li><a href="{url /plan}">Kế hoạch</a></li>
			<li><a href="{url /task}">Tiến độ</a></li>
		</ul>	
	</li>
	<li>
		<a href="{url /student/order}">Hóa đơn</a>
		<ul>
			<li><a href="{url /student/order}">Học phí</a></li>
			<li><a href="{url /order/report}">Báo cáo</a></li>
			<li><a href="{url /order/billing}">Hóa đơn chi</a></li>
			<li><a href="{url /order/createbill}">Tạo HĐ Chi Nhiều Mục</a></li>
			<li><a href="{url /order/createbill2}">Tạo HĐ Chi Một Mục</a></li>
			<li><a href="{url /order/createordermanual}">Tạo HĐ Thu</a></li>
		</ul>
	</li>
	<li>
		<a href="{url /asset}">Tài sản</a>
		<ul>
			<li><a href="{url /asset/facility}">Phương tiện</a></li>
			<li><a href="{url /asset/online}">Trực tuyến</a></li>
			<li><a href="{url /asset/document}">Tài liệu</a></li>
			<li><a href="{url /asset/schedule}">Bàn giao tài sản</a></li>
			<li><a href="#">Thu hồi bàn giao tài sản</a></li>
			<li><a href="#">Hóa đơn nhập/mua</a></li>
			<li><a href="#">Hóa đơn thanh lý</a></li>
		</ul>
	</li>
	<li><a href="{url /demo/logout}">Thoát</a></li>
</ul>
<br />
<div style="display: none;">

<a href="#" onclick="getRemoteDatas(); return false;">Lấy dữ liệu</a> | Đã lấy: <span id="got_count"></span> Bản ghi | <a href="#" onClick="indexStudentData(); return false;">Index dữ liệu</a>
<br />
</div>
<script>
var remotes = [
	// student
{
	source: {
		url: 'http://api2.nextnobels.com/coreusers',
		type: 'get',
		dataType: 'json',
		async: false,
		data: {
			sort: 'id asc',
			limit: 50,
			where: {
			}
		},
		lastid: function(success, lastid) {
			$.ajax({
				url: '/index.php/dtable/lastid?table=student',
				type: 'post',
				dataType: 'json',
				async: false,
				data: {
					lastid: lastid || ''
				},
				success: function(resp) {
					if(lastid) {
						success(resp);
					} else {
						var where = {
							id: {
								'>': resp
							}
						};
						success(where);
					}
				}
			});
		}
	},
	target: {
		url: '/index.php/Dtable/addmul?table=student',
		type: 'post',
		dataType: 'json',
		async: false,
		data: {
			online: 1,
			status: 0
		},
		map: {
			name: 'name',
			phone: 'phone',
			email: 'email',
			code: 'username',
			birthDate: 'birthday',
			adviceNote: 'note',
			birthYear: function(field, item) {
				return item.birthday.substr(0, 4);
			},
			startStudyDate: function(field, item) {
				var registered = item.registered;
				return registered.substr(0, 10);
			},
			adviceStatus: function(field, item) {
				var note = item.note;
				if($.trim(note) !== '') {
					return 1;
				}
				return 0;
			}
		}
	}
	
},
// services
{
	source: {
		url: 'http://api2.nextnobels.com/ecommercepayments',
		type: 'get',
		dataType: 'json',
		async: false,
		data: {
			sort: 'id asc',
			limit: 50,
			where: {
			}
		},
		lastid: function(success, lastid) {
			$.ajax({
				url: '/index.php/dtable/lastid?table=class_student',
				type: 'post',
				dataType: 'json',
				async: false,
				data: {
					lastid: lastid || ''
				},
				success: function(resp) {
					if(lastid) {
						success(resp);
					} else {
						var where = {
							id: {
								'>': resp
							}
						};
						success(where);
					}
				}
			});
		}
	},
	target: {
		url: '/index.php/Dtable/addmul?table=class_student',
		type: 'post',
		dataType: 'json',
		async: false,
		data: {
			studentId: 0
		},
		map: {
			classId: function(field, item) {
				return 247;
			},
			code: function(field, item) {
				return item.username;
			},
			startClassDate: function(field, item) {
				return item.paymentDate.substr(0, 10);
			},
			endClassDate: function(field, item) {
				return item.expiredDate.substr(0, 10);
			}
		}
	}
	
}
];
// import tất cả các source vào database
function getRemoteDatas() {
	remotes.forEach(function(remote) {
		getRemoteData(remote);
	});
	if(typeof pzk.elements.dg !== 'undefined') {
		pzk.elements.dg.reload();
	}
}

// thực hiện import theo từng remote source
function getRemoteData(remote) {
	loadRemoteDataFromSource(remote.source, function(resp){
		processImportDataToTarget(resp, remote.target, remote, function(processResp){
			if(processResp.errorMsg) {
				$.messager.show({
					title: 'Lỗi',
					msg: processResp.errorMsg
				});
			} else {
				if(0) {
					$.messager.show({
						title: 'Thành công',
						msg: 'Đã import thành công ' + processResp.data.name
					});
				}
				
			}
		});
	});
}

// lấy dữ liệu từ source về
function loadRemoteDataFromSource(source, success) {
	source.lastid(function(where){
		source.success = success;
		$.extend(source.data.where, where);
		$.ajax(source);
	});
}

// import vào database
function processImportDataToTarget(resp, target, remote, success) {
	if(0) {
		// OLD insert
		resp.forEach(function(item, index){
			$('#got_count').text('' + (index + 1));
			var map = target.map;
			for(var field in map) {
				var value = null;
				var mapField = map[field];
				if(typeof mapField === 'function') {
					value = mapField(field, item);
				} else {
					value = item[mapField]
				}
				target.data[field] = value;
			}
			target.success = success;
			target.async = false;
			$.ajax(target);
			
		});
	} else {
		var items = [];
		resp.forEach(function(item, index){
			$('#got_count').text('' + (index + 1));
			var map = target.map;

			// lưu data cần insert vào itemData
			var itemData = {};
			for(var field in target.data) {
				itemData[field] = target.data[field];
			}

			// chuyển đổi data từ nguồn sang đích
			for(var field in map) {
				var value = null;
				var mapField = map[field];
				if(typeof mapField === 'function') {
					value = mapField(field, item);
				} else {
					value = item[mapField]
				}
				itemData[field] = value;
			}

			// lưu vào items
			if(typeof remote.source.skip !== 'undefined') {
				if(!remote.source.skip(itemData)) {
					items.push(itemData);
				}
			} else {
				items.push(itemData);
			}
			
			
		});
		var targetOptions = {
			url: target.url,
			type: target.type || 'post',
			dataType: target.dataType || 'json',
			data: {
				items: items
			},
			async: false,
			success: success
		}; 
		// console.log(targetOptions);
		// return true;
		$.ajax(targetOptions);
	}

	if(resp.length) {
		// Lưu lại lastid
		lastid = resp[resp.length - 1].id;
		remote.source.lastid(function(resp) {
			$.messager.show({
				title: 'Lưu lastid',
				msg: 'Đã lưu lastid: ' + lastid
			});

			// chạy lại hàm lấy dữ liệu
			if(1) {
				getRemoteData(remote);
			}
		}, lastid);

		if(typeof pzk.elements.dg != 'undefined') {
			// pzk.elements.dg.reload();
		}
	}
}

function indexStudentData() {
	pzk.ajax({
		url: '/index.php/Home/indexStudent',
		data: {},
		success: function(resp) {
			$.messager.show({
				title: 'Thành công',
				msg: resp.msg
			});
			if(typeof pzk.elements.dg !== 'undefined') {
				pzk.elements.dg.reload();
			}
		}
	});
}

</script>